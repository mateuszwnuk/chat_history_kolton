<!doctype html>
<html lang="pl">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Historia czat√≥w z Supabase</title>
  <style>
    :root{
      --bg:#0b0c10;--panel:#121319;--panel-soft:#141923;--muted:#9aa3af;--text:#e8eaee;--accent:#60a5fa;
      --chip-human:#34d399;--chip-ai:#f59e0b;--chip-system:#a78bfa;--border:#232839;--border-strong:#2b3246;--danger:#ef4444;
      --summary-bg:#171d29;--summary-bg-hover:#1a2130;--summary-text:#eef2ff;--badge-bg:#0f1521;--good:#2bd576;
    }
    *{box-sizing:border-box}
    body{margin:0;padding:24px;background:var(--bg);color:var(--text);
      font:14px/1.5 system-ui,-apple-system,Segoe UI,Roboto,Inter,Arial,sans-serif}
    h1{font-size:18px;margin:0 0 16px}
    .card{background:var(--panel);border:1px solid var(--border);border-radius:14px;padding:16px;box-shadow:0 6px 24px rgba(0,0,0,.18)}
    .row{display:flex;gap:12px;flex-wrap:wrap;align-items:center}
    .row>*{flex:1 1 auto}
    input,button,select{
      background:#0f1117;color:var(--text);border:1px solid var(--border);
      border-radius:10px;padding:10px 12px;outline:none
    }
    button{cursor:pointer;transition:transform .05s ease,border-color .2s ease,background .2s ease}
    button:hover{transform:translateY(-1px);border-color:var(--accent)}
    button[disabled]{opacity:.6;cursor:not-allowed}
    .muted{color:var(--muted)}
    .toolbar{display:flex;gap:8px;flex-wrap:wrap;margin:12px 0 0;align-items:center}
    .sessions{margin-top:16px;display:grid;gap:10px}

    /* Rozwijki ja≈õniejsze */
    details.session{border:1px solid var(--border-strong);border-radius:12px;overflow:hidden;background:var(--panel-soft)}
    details.session>summary{
      list-style:none;padding:12px 14px;display:flex;gap:12px;align-items:center;cursor:pointer;user-select:none;
      font-weight:700;background:var(--summary-bg);color:var(--summary-text);border-bottom:1px solid var(--border-strong)
    }
    details.session[open]>summary{border-bottom-color:var(--border)}
    details.session>summary:hover{background:var(--summary-bg-hover)}
    details.session>summary:focus{outline:2px solid var(--accent);outline-offset:-2px;border-radius:10px}
    details.session>summary .chev{width:10px;height:10px;border-right:2px solid #a6b4d9;border-bottom:2px solid #a6b4d9;transform:rotate(-45deg);transition:transform .15s ease;margin-right:2px}
    details.session[open]>summary .chev{transform:rotate(45deg)}
    .badge{font-size:12px;color:#a6b4d9;background:var(--badge-bg);border:1px solid var(--border-strong);padding:4px 8px;border-radius:999px}
    .sid{font-family:ui-monospace,SFMono-Regular,Menlo,Consolas,monospace;background:#0e1422;border:1px solid var(--border);padding:2px 6px;border-radius:6px}
    .messages{padding:12px 12px 14px;display:grid;gap:10px}
    .msg{border:1px solid var(--border);border-radius:12px;padding:10px 12px;background:#151b28;display:grid;gap:6px}
    .msg .head{display:flex;gap:8px;align-items:center;justify-content:space-between}
    .type{font-size:11px;text-transform:uppercase;letter-spacing:.06em;font-weight:800;padding:3px 8px;border-radius:999px;border:1px solid var(--border)}
    .type.human{background:rgba(52,211,153,.12);color:var(--chip-human)}
    .type.ai{background:rgba(245,158,11,.12);color:var(--chip-ai)}
    .type.system,.type.tool{background:rgba(167,139,250,.12);color:var(--chip-system)}
    .id{font-size:12px;color:var(--muted)}
    pre.content{margin:0;white-space:pre-wrap;word-break:break-word;font-family:ui-monospace,SFMono-Regular,Menlo,Consolas,monospace;background:#0e1422;border:1px solid var(--border);border-radius:10px;padding:10px 12px}

    .status{margin-top:12px}
    .danger{color:var(--danger)}
    .footer{margin-top:16px;color:var(--muted);font-size:12px}
    .grow{flex:1 1 100%}
    .spacer{flex:1}

    /* üîî Plakietka nowych wiadomo≈õci */
    .notify-badge{
      display:inline-flex;align-items:center;gap:6px;padding:8px 10px;border:1px solid var(--border-strong);border-radius:999px;background:#101628
    }
    .dot{width:8px;height:8px;border-radius:999px;background:var(--good)}
    .count{font-weight:800}
    .pulse{animation:pulse 1.2s ease-out 3}
    @keyframes pulse{
      0%{box-shadow:0 0 0 0 rgba(43,213,118,.5)}
      100%{box-shadow:0 0 0 14px rgba(43,213,118,0)}
    }

    /* üö© Wulgaryzmy */
    .flag{display:inline-flex;align-items:center;gap:6px;color:var(--danger);font-weight:800}
    .msg.bad{border-color:var(--danger)}
    .hidden{display:none !important}
  </style>
</head>
<body>
  <h1>Historia czat√≥w z Supabase ‚Üí grupowanie wg <code>session_id</code></h1>

  <div class="card">
    <div class="row">
      <input id="url" placeholder="SUPABASE_URL" />
      <input id="key" placeholder="SUPABASE_ANON_KEY" />
      <input id="table" placeholder="NAZWA TABELI" />
    </div>

    <div class="toolbar">
      <button id="refresh">Od≈õwie≈º</button>

      <span class="spacer"></span>

      <label class="muted"><input type="checkbox" id="autoToggle" checked style="vertical-align:middle;margin-right:6px;">Auto-od≈õwie≈ºanie</label>
      <select id="intervalSelect" title="Interwa≈Ç (sekundy)">
        <option value="10">co 10 s</option>
        <option value="20" selected>co 20 s</option>
        <option value="30">co 30 s</option>
        <option value="60">co 60 s</option>
      </select>

      <label class="muted"><input type="checkbox" id="notifToggle" checked style="vertical-align:middle;margin-right:6px;">Powiadomienia</label>
      <label class="muted"><input type="checkbox" id="soundToggle" checked style="vertical-align:middle;margin-right:6px;">D≈∫wiƒôk</label>
      <label class="muted"><input type="checkbox" id="profanityToggle" checked style="vertical-align:middle;margin-right:6px;">Oznaczaj wulgaryzmy</label>
      <button id="testNotify">Test</button>

      <button id="expandAll" disabled>Rozwi≈Ñ wszystkie</button>
      <button id="collapseAll" disabled>Zwi≈Ñ wszystkie</button>
    </div>

    <div class="toolbar" style="margin-top:10px">
      <input id="search" class="grow" placeholder="Szukaj po tre≈õci lub session_id‚Ä¶" />
      <select id="typeFilter" title="Filtr typu">
        <option value="">Typ: wszystkie</option>
        <option value="human">Tylko human</option>
        <option value="ai">Tylko ai</option>
        <option value="system">Tylko system</option>
        <option value="tool">Tylko tool</option>
      </select>

      <!-- üîî plakietka -->
      <div id="newBadge" class="notify-badge" style="display:none">
        <span class="dot"></span>
        <span>Nowe:</span>
        <span class="count" id="newCount">0</span>
      </div>

      <div class="muted" id="lastUpdated">Ostatnia aktualizacja: ‚Äî</div>
    </div>

    <div class="status muted" id="status">≈Åadowanie‚Ä¶</div>
    <div class="sessions" id="sessions"></div>

    <div class="footer">
      Wskaz√≥wka: dla szybko≈õci dodaj indeks: <code>CREATE INDEX ON chatmemories (session_id, id);</code>
    </div>
  </div>

  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2/dist/umd/supabase.js"></script>
  <script>
    // ‚úÖ Twoje dane
    const DEFAULTS = {
      SUPABASE_URL: "https://kiecgkztsycuwplpbtbs.supabase.co",
      SUPABASE_ANON_KEY: "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImtpZWNna3p0c3ljdXdwbHBidGJzIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTg4ODc2NDAsImV4cCI6MjA3NDQ2MzY0MH0.WnzO0OqMur8eoXWB8ZjNBtHEVAK-rKPNftNATerYGsM",
      TABLE_NAME: "chatmemories"
    };

    let client=null, rawRows=[], sessionsMap={}, autoTimer=null;
    let seenIds=new Set(), initialized=false;

    // UI refs
    const el=id=>document.getElementById(id);
    const $url=el('url'), $key=el('key'), $table=el('table');
    const $status=el('status'), $sessions=el('sessions');
    const $expandAll=el('expandAll'), $collapseAll=el('collapseAll');
    const $search=el('search'), $typeFilter=el('typeFilter');
    const $refresh=el('refresh'), $autoToggle=el('autoToggle'), $intervalSelect=el('intervalSelect');
    const $notifToggle=el('notifToggle'), $soundToggle=el('soundToggle'), $testNotify=el('testNotify');
    const $profanityToggle=el('profanityToggle');
    const $lastUpdated=el('lastUpdated'), $newBadge=el('newBadge'), $newCount=el('newCount');

    // Prefill
    $url.value=DEFAULTS.SUPABASE_URL;
    $key.value=DEFAULTS.SUPABASE_ANON_KEY;
    $table.value=DEFAULTS.TABLE_NAME;

    // ---- WULGARYZMY ----
    // Lista rdzeni/wyra≈ºe≈Ñ (oko≈Ço 30) ‚Äî dopasowujemy po tek≈õcie bez diakrytyk√≥w, case-insensitive.
    const PROFANITY_STEMS = [
      'kurw', 'chuj', 'huj', 'kutas', 'pizd', 'pierdol', 'pierdziel', 'jeba', 'zajeb',
      'spierdal', 'wypierdal', 'zapierdal', 'odpierdol', 'przejeb', 'dojeb', 'ujeb',
      'wyjeb', 'najeb', 'zjeb', 'pojeb', 'skurwysyn', 'skurw', 'sukinsyn',
      'kurew', 'kurwis', 'kurtyzan' /* historyczne/≈Çagodne, ale czasem wulg. */,
      'cip', 'fiut', 'sral', 'srac', 'sram', 'g√≥wno', 'gowno', 'dupa', 'dupie',
      'ciul' /* regionalne */, 'raszpla' /* potoczne mocne */, 'pierd', 'suki?'
    ];
    // Upro≈õƒá na ASCII + ma≈Çe litery (by ≈Çapaƒá u/√≥/ƒÖ/ƒô/≈õ/ƒá/≈Ñ/≈Ç/≈º/≈∫)
    function simplify(s){
      return (s||'')
        .toLowerCase()
        .normalize('NFD')
        .replace(/\p{Diacritic}/gu,'');
    }
    function hasProfanity(text){
      if(!$profanityToggle.checked) return false;
      const t = simplify(text);
      for(const stem of PROFANITY_STEMS){
        if(t.includes(stem)) return true;
      }
      return false;
    }

    // ---- D≈πWIƒòK ----
    let audioCtx=null;
    function ensureAudioCtx(){
      if(!audioCtx){
        try{ audioCtx=new (window.AudioContext||window.webkitAudioContext)(); }catch{}
      }
    }
    function playDing(){
      if(!$soundToggle.checked) return;
      ensureAudioCtx();
      if(!audioCtx) return;
      const o=audioCtx.createOscillator();
      const g=audioCtx.createGain();
      o.type='sine';
      o.frequency.setValueAtTime(880, audioCtx.currentTime);
      g.gain.setValueAtTime(0, audioCtx.currentTime);
      g.gain.linearRampToValueAtTime(0.15, audioCtx.currentTime+0.01);
      g.gain.exponentialRampToValueAtTime(0.0001, audioCtx.currentTime+0.25);
      o.connect(g); g.connect(audioCtx.destination);
      o.start(); o.stop(audioCtx.currentTime+0.3);
    }

    // ---- Systemowe powiadomienia ----
    async function ensureNotifPermission(){
      if(!$notifToggle.checked) return false;
      if(!('Notification' in window)) return false;
      if(Notification.permission==='granted') return true;
      if(Notification.permission==='denied') return false;
      const r=await Notification.requestPermission(); return r==='granted';
    }
    async function showNotification(count){
      if(!$notifToggle.checked) return;
      if(!('Notification' in window)) return;
      if(Notification.permission!=='granted'){ const ok=await ensureNotifPermission(); if(!ok) return; }
      const n=new Notification('Nowe wiadomo≈õci', {
        body: `Pojawi≈Ço siƒô ${count} nowych wpis√≥w.`,
        tag: 'chatmemories-update'
      });
      setTimeout(()=>n.close(), 4000);
    }

    function bumpBadge(by){
      const current=parseInt($newCount.textContent||'0',10);
      const next=current+by;
      $newCount.textContent=String(next);
      $newBadge.style.display='inline-flex';
      $newBadge.classList.remove('pulse'); void $newBadge.offsetWidth; $newBadge.classList.add('pulse');
    }
    function resetBadge(){ $newCount.textContent='0'; $newBadge.style.display='none'; }

    function parseMessage(m){
      try{ if(!m) return {type:'unknown',content:''}; if(typeof m==='string') return JSON.parse(m); return m; }
      catch{ return {type:'unknown',content:String(m)} }
    }
    function groupBySession(rows){
      const map={};
      for(const r of rows){
        const sid=r.session_id??'‚Äîbrak‚Äî';
        (map[sid]??=[]).push(r);
      }
      Object.keys(map).forEach(sid=>map[sid].sort((a,b)=>(a.id??0)-(b.id??0)));
      return map;
    }

    function render(){
      const q=$search.value.trim().toLowerCase();
      const tf=$typeFilter.value;
      $sessions.innerHTML='';
      const sids=Object.keys(sessionsMap).sort();
      let shownGroups=0, shownMsgs=0;

      for(const sid of sids){
        const rows=sessionsMap[sid].filter(r=>{
          const msg=parseMessage(r.message);
          const okType=!tf||((msg.type||'').toLowerCase()===tf);
          const text=`${sid} ${msg.content||''}`.toLowerCase();
          const okQuery=!q||text.includes(q);
          return okType&&okQuery;
        });
        if(!rows.length) continue;
        shownGroups++;

        const total=sessionsMap[sid].length;

        // sprawd≈∫ czy w sesji wystƒôpuje jakikolwiek wulgaryzm
        let sessionHasProfanity=false;
        for(const r of rows){
          const m=parseMessage(r.message);
          if(hasProfanity(m.content||'')){ sessionHasProfanity=true; break; }
        }

        const details=document.createElement('details');
        details.className='session';

        const summary=document.createElement('summary');
        summary.innerHTML=`
          <span class="chev"></span>
          ${sessionHasProfanity ? `<span class="flag" title="Wulgaryzmy w wƒÖtku">‚ö†Ô∏è</span>` : ''}
          <span>Sesja: <span class="sid">${sid}</span></span>
          <span class="badge">wierszy: ${rows.length}/${total}</span>
        `;

        const wrap=document.createElement('div'); wrap.className='messages';
        for(const r of rows){
          shownMsgs++;
          const msg=parseMessage(r.message);
          const type=(msg.type||'unknown').toLowerCase();
          const content=(msg.content??'').toString();
          const isBad=hasProfanity(content);

          const div=document.createElement('div');
          div.className='msg'+(isBad?' bad':'');
          div.innerHTML=`
            <div class="head">
              <div class="type ${type}">${type}</div>
              <div class="id">id: ${r.id??'‚Äî'}</div>
            </div>
            <pre class="content"></pre>
          `;
          div.querySelector('pre.content').textContent=content;
          wrap.appendChild(div);
        }

        details.appendChild(summary); details.appendChild(wrap);
        $sessions.appendChild(details);
      }

      $expandAll.disabled = shownGroups===0;
      $collapseAll.disabled = shownGroups===0;
      $status.innerHTML = shownGroups ? `Poka¬≠zano grup: <b>${shownGroups}</b>, wiadomo≈õci: <b>${shownMsgs}</b>.` : 'Brak wynik√≥w dla filtr√≥w.';
    }

    async function fetchAllRows(){
      const table=$table.value.trim(); if(!table) throw new Error('Podaj nazwƒô tabeli.');
      const {data,error}=await client
        .from(table)
        .select('id, session_id, message')
        .order('session_id',{ascending:true})
        .order('id',{ascending:true})
        .limit(5000);
      if(error) throw error;
      return data||[];
    }
    function ensureClient(){
      if(client) return;
      const url=$url.value.trim(), key=$key.value.trim();
      if(!url||!key) throw new Error('Brakuje SUPABASE_URL lub SUPABASE_ANON_KEY.');
      client=window.supabase.createClient(url,key);
    }
    function setLastUpdated(){
      const d=new Date();
      $lastUpdated.textContent='Ostatnia aktualizacja: '+d.toLocaleTimeString();
    }

    async function loadAndRender(){
      try{
        $refresh.disabled=true;
        $status.innerHTML='≈ÅƒÖczenie z Supabase‚Ä¶';
        ensureClient();

        $status.innerHTML='Pobieram dane‚Ä¶';
        const newData=await fetchAllRows();

        // üîé detekcja nowych ID
        let newlyFound=0;
        for(const row of newData){
          if(row && typeof row.id!=='undefined' && !seenIds.has(row.id)){
            newlyFound++;
          }
        }

        rawRows=newData;
        sessionsMap=groupBySession(rawRows);
        render();
        setLastUpdated();

        const allIds=new Set(newData.map(r=>r?.id).filter(v=>v!==undefined));
        if(!initialized){
          seenIds=allIds;
          initialized=true;
          resetBadge();
        }else{
          if(newlyFound>0){
            bumpBadge(newlyFound);
            playDing();
            showNotification(newlyFound);
          }
          seenIds=allIds;
        }

      }catch(e){
        console.error(e);
        $status.innerHTML=`<span class="danger">B≈ÇƒÖd: ${e.message}</span>`;
      }finally{
        $refresh.disabled=false;
      }
    }

    function startAuto(){
      stopAuto();
      const sec=parseInt($intervalSelect.value,10)||20;
      autoTimer=setInterval(loadAndRender, sec*1000);
      $status.innerHTML=`Auto-od≈õwie≈ºanie aktywne (co ${sec}s)`;
    }
    function stopAuto(){ if(autoTimer){ clearInterval(autoTimer); autoTimer=null; } }

    // UI events
    $search.addEventListener('input',render);
    $typeFilter.addEventListener('change',render);
    $refresh.addEventListener('click',()=>{ ensureAudioCtx(); loadAndRender(); });
    el('expandAll').addEventListener('click',()=>{document.querySelectorAll('details.session').forEach(d=>d.open=true)});
    el('collapseAll').addEventListener('click',()=>{document.querySelectorAll('details.session').forEach(d=>d.open=false)});

    $autoToggle.addEventListener('change',()=> $autoToggle.checked ? startAuto() : stopAuto());
    $intervalSelect.addEventListener('change',()=>{ if($autoToggle.checked) startAuto(); });

    $notifToggle.addEventListener('change', async ()=>{ if($notifToggle.checked){ await ensureNotifPermission(); }});
    $soundToggle.addEventListener('change', ()=>{ if($soundToggle.checked) ensureAudioCtx(); });

    $profanityToggle.addEventListener('change', ()=>{ render(); });

    $testNotify.addEventListener('click', async ()=>{
      ensureAudioCtx(); playDing();
      await ensureNotifPermission();
      showNotification(1);
      bumpBadge(1);
      setTimeout(()=>resetBadge(), 1200);
    });

    // Auto-start
    window.addEventListener('load', async ()=>{
      ensureClient();
      await loadAndRender();
      if($autoToggle.checked) startAuto();
    });
  </script>
</body>
</html>
